<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RigRanger Server</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        :root {
            --primary-color: #1976d2;
            --secondary-color: #424242;
            --background-color: #f5f5f5;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --text-color: #212121;
            --light-text: #f5f5f5;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        header {
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        main {
            max-width: 1200px;
            margin: 1rem auto;
            padding: 1rem;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-header h2 {
            margin: 0;
            font-size: 1.3rem;
            color: var(--primary-color);
        }

        .radio-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .control-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        input, select, button {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #0d5aa7;
        }

        .button-secondary {
            background-color: var(--secondary-color);
        }

        .button-secondary:hover {
            background-color: #323232;
        }

        .log-container {
            height: 200px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.5rem;
            font-family: monospace;
            margin-top: 0.5rem;
        }

        .log-entry {
            margin-bottom: 0.25rem;
            padding: 0.25rem;
            border-bottom: 1px solid #eee;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--error-color);
        }

        .indicator.connected {
            background-color: var(--success-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        footer {
            background-color: var(--secondary-color);
            color: var(--light-text);
            text-align: center;
            padding: 1rem;
            margin-top: 2rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <img src="logo.svg" alt="RigRanger Logo" width="40">
            <h1>RigRanger Server</h1>
        </div>
        <div class="status-indicator">
            <span id="connection-status">Disconnected</span>
            <div id="status-indicator" class="indicator"></div>
        </div>
    </header>

    <main>
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <h2>Radio Control</h2>
                </div>
                <div class="radio-controls">
                    <div class="control-group">
                        <label for="frequency">Frequency (MHz)</label>
                        <input type="number" id="frequency" step="0.001" min="0.1" max="3000">
                    </div>
                    <div class="control-group">
                        <label for="mode">Mode</label>
                        <select id="mode">
                            <option value="USB">USB</option>
                            <option value="LSB">LSB</option>
                            <option value="AM">AM</option>
                            <option value="FM">FM</option>
                            <option value="CW">CW</option>
                            <option value="RTTY">RTTY</option>
                            <option value="DATA">DATA</option>
                        </select>
                    </div>
                </div>
                <div class="control-group">
                    <button id="set-freq-mode">Set Frequency & Mode</button>
                </div>
                <div class="control-group">
                    <label for="ptt">PTT Control</label>
                    <button id="ptt-toggle" class="button-secondary">Press to Talk (PTT Off)</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Radio Information</h2>
                </div>
                <table>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                    <tr>
                        <td>Connected Radio</td>
                        <td id="radio-model">--</td>
                    </tr>
                    <tr>
                        <td>Device</td>
                        <td id="radio-device">--</td>
                    </tr>
                    <tr>
                        <td>Current Frequency</td>
                        <td id="current-frequency">--</td>
                    </tr>
                    <tr>
                        <td>Current Mode</td>
                        <td id="current-mode">--</td>
                    </tr>
                    <tr>
                        <td>S-Meter</td>
                        <td id="s-meter">--</td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Server Log</h2>
                <button id="clear-log" class="button-secondary">Clear Log</button>
            </div>
            <div id="log-container" class="log-container"></div>
        </div>
    </main>

    <footer>
        <p>RigRanger Server &copy; 2023 | A lightweight amateur radio control server</p>
    </footer>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Socket.IO
            const socket = io();
            const logContainer = document.getElementById('log-container');
            const statusIndicator = document.getElementById('status-indicator');
            const connectionStatus = document.getElementById('connection-status');

            // Connection status
            socket.on('connect', function() {
                addLogEntry('Connected to server');
                connectionStatus.textContent = 'Connected to server';
                statusIndicator.classList.add('connected');

                // Request radio status
                socket.emit('hamlib-function', {
                    function: 'get_info',
                    args: []
                });
            });

            socket.on('disconnect', function() {
                addLogEntry('Disconnected from server');
                connectionStatus.textContent = 'Disconnected';
                statusIndicator.classList.remove('connected');

                document.getElementById('radio-model').textContent = '--';
                document.getElementById('radio-device').textContent = '--';
                document.getElementById('current-frequency').textContent = '--';
                document.getElementById('current-mode').textContent = '--';
                document.getElementById('s-meter').textContent = '--';
            });

            // Handle server status updates
            socket.on('server-status', function(data) {
                addLogEntry(`Server status: ${data.status}`);
            });

            // Handle Hamlib status updates
            socket.on('hamlib-status', function(data) {
                addLogEntry(`Hamlib status: ${data.status} - ${data.message}`);

                if (data.status === 'connected') {
                    connectionStatus.textContent = 'Connected to radio';
                    statusIndicator.classList.add('connected');

                    // Request radio info
                    socket.emit('hamlib-function', {
                        function: 'get_info',
                        args: []
                    });
                } else {
                    connectionStatus.textContent = `Radio: ${data.status}`;
                    statusIndicator.classList.remove('connected');
                }
            });

            // Handle function responses
            socket.on('function-response', function(data) {
                if (data.error) {
                    addLogEntry(`Error: ${data.error}`);
                    return;
                }

                if (data.function === 'get_info') {
                    document.getElementById('radio-model').textContent = data.result.model || '--';
                    document.getElementById('radio-device').textContent = data.result.device || '--';

                    if (data.result.frequency) {
                        const freqMHz = (data.result.frequency / 1000000).toFixed(6);
                        document.getElementById('current-frequency').textContent = `${freqMHz} MHz`;
                        document.getElementById('frequency').value = freqMHz;
                    }

                    if (data.result.mode) {
                        document.getElementById('current-mode').textContent = data.result.mode;
                        document.getElementById('mode').value = data.result.mode;
                    }
                }
                else if (data.function === 'get_frequency') {
                    const freqMHz = (data.result / 1000000).toFixed(6);
                    document.getElementById('current-frequency').textContent = `${freqMHz} MHz`;
                }
                else if (data.function === 'get_mode') {
                    document.getElementById('current-mode').textContent = data.result.mode;
                }
                else if (data.function === 'get_level') {
                    if (data.args[0] === 'STRENGTH') {
                        document.getElementById('s-meter').textContent = `${data.result} dB`;
                    }
                }
            });

            // Set frequency and mode button
            document.getElementById('set-freq-mode').addEventListener('click', function() {
                const frequency = parseFloat(document.getElementById('frequency').value) * 1000000; // Convert to Hz
                const mode = document.getElementById('mode').value;

                if (isNaN(frequency) || frequency <= 0) {
                    addLogEntry('Error: Invalid frequency');
                    return;
                }

                // Set frequency
                socket.emit('hamlib-function', {
                    function: 'set_frequency',
                    args: [frequency]
                });

                // Set mode
                socket.emit('hamlib-function', {
                    function: 'set_mode',
                    args: [mode]
                });

                addLogEntry(`Setting frequency to ${frequency / 1000000} MHz and mode to ${mode}`);
            });

            // PTT toggle button
            let pttState = false;
            const pttButton = document.getElementById('ptt-toggle');

            pttButton.addEventListener('click', function() {
                pttState = !pttState;

                socket.emit('hamlib-function', {
                    function: 'set_ptt',
                    args: [pttState]
                });

                if (pttState) {
                    pttButton.textContent = 'Release PTT (PTT On)';
                    pttButton.style.backgroundColor = 'var(--error-color)';
                } else {
                    pttButton.textContent = 'Press to Talk (PTT Off)';
                    pttButton.style.backgroundColor = '';
                }

                addLogEntry(`PTT ${pttState ? 'activated' : 'deactivated'}`);
            });

            // Clear log button
            document.getElementById('clear-log').addEventListener('click', function() {
                logContainer.innerHTML = '';
            });

            // Helper function to add log entries
            function addLogEntry(message) {
                const entry = document.createElement('div');
                entry.className = 'log-entry';

                const timestamp = new Date().toLocaleTimeString();
                entry.textContent = `[${timestamp}] ${message}`;

                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            // Periodic updates
            function updateRadioStatus() {
                if (socket.connected) {
                    // Update frequency
                    socket.emit('hamlib-function', {
                        function: 'get_frequency',
                        args: []
                    });

                    // Update S-meter
                    socket.emit('hamlib-function', {
                        function: 'get_level',
                        args: ['STRENGTH']
                    });
                }
            }

            // Update every 2 seconds
            setInterval(updateRadioStatus, 2000);
        });
    </script>
</body>
</html>
